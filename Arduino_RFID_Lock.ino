/***************************************************************
 * üîí Arduino RFID Lock System (–º—É–ª—å—Ç–∏–¥–æ—Å—Ç—É–ø)
 * ------------------------------------------------------------
 * –≠—Ç–æ—Ç —Å–∫–µ—Ç—á —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∑–∞–º–æ–∫ –Ω–∞ RFID-–∫–∞—Ä—Ç–∞—Ö —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é
 * –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö UID-–∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–∞.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥—É–ª—å MFRC522 (SPI) –∏ –ø–∏–Ω —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–∫–æ–º.
 ***************************************************************/

#include <SPI.h>        // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SPI-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
#include <MFRC522.h>    // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è RFID-–º–æ–¥—É–ª—è MFRC522

// --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∏–Ω–æ–≤ ---
#define RST_PIN 9       // –ü–∏–Ω RST (Reset) –º–æ–¥—É–ª—è RFID
#define SS_PIN 10       // –ü–∏–Ω SS (SDA) ‚Äî –≤—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ SPI
#define LOCK_PIN 7      // –ü–∏–Ω, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –∑–∞–º–∫–æ–º (—Ä–µ–ª–µ, MOSFET, —Å–≤–µ—Ç–æ–¥–∏–æ–¥)

// –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç RFID-—Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –ø–∏–Ω–∞–º–∏
MFRC522 mfrc522(SS_PIN, RST_PIN);

/***************************************************************
 * setup() ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Arduino
 ***************************************************************/
void setup() {
  Serial.begin(9600);               // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
  SPI.begin();                      // –ó–∞–ø—É—Å–∫ —à–∏–Ω—ã SPI
  mfrc522.PCD_Init();               // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RFID-–º–æ–¥—É–ª—è
  pinMode(LOCK_PIN, OUTPUT);        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–∞ –∑–∞–º–∫–∞ –∫–∞–∫ –≤—ã—Ö–æ–¥–∞
  digitalWrite(LOCK_PIN, LOW);      // –ó–∞–º–æ–∫ –∑–∞–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  Serial.println("–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –ü—Ä–∏–ª–æ–∂–∏—Ç–µ –∫–∞—Ä—Ç—É...");
}

/***************************************************************
 * loop() ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
 ***************************************************************/
void loop() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –≤ –∑–æ–Ω–µ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è
  if (!mfrc522.PICC_IsNewCardPresent()) return;

  // –ü—ã—Ç–∞–µ–º—Å—è —Å—á–∏—Ç–∞—Ç—å UID –∫–∞—Ä—Ç—ã
  if (!mfrc522.PICC_ReadCardSerial()) return;

  // –í—ã–≤–æ–¥–∏–º UID –≤ –º–æ–Ω–∏—Ç–æ—Ä –ø–æ—Ä—Ç–∞
  Serial.print("–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–∞—Ä—Ç–∞ UID: ");
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    Serial.print(mfrc522.uid.uidByte[i] < 0x10 ? " 0" : " ");
    Serial.print(mfrc522.uid.uidByte[i], HEX);
  }
  Serial.println();

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ –¥–æ—Å—Ç—É–ø
  if (checkUID(mfrc522.uid.uidByte, mfrc522.uid.size)) {
    Serial.println("‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω! –ó–∞–º–æ–∫ –æ—Ç–∫—Ä—ã—Ç –Ω–∞ 0.5 —Å–µ–∫—É–Ω–¥—ã.");
    digitalWrite(LOCK_PIN, HIGH); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∑–∞–º–æ–∫
    delay(500);
    digitalWrite(LOCK_PIN, LOW);  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∑–∞–º–æ–∫
    Serial.println("–ó–∞–º–æ–∫ —Å–Ω–æ–≤–∞ –∑–∞–∫—Ä—ã—Ç.");
  } else {
    Serial.println("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω! –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞.");
  }

  // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É —Å –∫–∞—Ä—Ç–æ–π
  mfrc522.PICC_HaltA();
  mfrc522.PCD_StopCrypto1();

  // –ü—Ä–æ—Å–∏–º —É–±—Ä–∞—Ç—å –∫–∞—Ä—Ç—É
  Serial.println("–£–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É...");
  while (mfrc522.PICC_IsNewCardPresent() || mfrc522.PICC_ReadCardSerial()) {
    delay(100);
  }

  Serial.println("–ú–æ–∂–Ω–æ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞—Ç—å —Å–Ω–æ–≤–∞.");
  delay(500);
}

/***************************************************************
 * checkUID() ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ UID –∫–∞—Ä—Ç—ã –ø–æ —Å–ø–∏—Å–∫—É —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö
 ***************************************************************/
bool checkUID(byte *uid, byte size) {
  // üîê –ú–∞—Å—Å–∏–≤ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö UID (–¥–æ–±–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏ –∫–∞—Ä—Ç—ã —Å—é–¥–∞)
  const byte authorizedUIDs[][4] = {
    {0x75, 0xBA, 0x7F, 0x05},  // –ö–∞—Ä—Ç–∞ ‚Ññ1
    {0xE4, 0x9A, 0x10, 0x7B},  // –ö–∞—Ä—Ç–∞ ‚Ññ2
    {0x12, 0x34, 0x56, 0x78}   // –ö–∞—Ä—Ç–∞ ‚Ññ3 (–ø—Ä–∏–º–µ—Ä)
  };

  const byte authorizedCount = sizeof(authorizedUIDs) / sizeof(authorizedUIDs[0]);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–ª–∏–Ω–∞ UID —Ä–∞–≤–Ω–∞ 4 –±–∞–π—Ç–∞–º
  if (size != 4) return false;

  // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ UID
  for (byte i = 0; i < authorizedCount; i++) {
    bool match = true;

    for (byte j = 0; j < 4; j++) {
      if (uid[j] != authorizedUIDs[i][j]) {
        match = false;
        break;
      }
    }

    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Äî –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω
    if (match) return true;
  }

  // –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π ‚Äî –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω
  return false;
}

